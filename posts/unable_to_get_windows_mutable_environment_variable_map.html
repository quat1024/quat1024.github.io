<!DOCTYPE html>

<html>
	<head>
		<title>Highly Suspect Agency - &quot;Unable to get Windows mutable environment variable map&quot;</title>
		<link rel="stylesheet" type="text/css" href="../stylin.css" />
		<link rel="stylesheet" type="text/css" href="../rotator.css" />
		
		<link rel="icon" type="image/x-icon" href="../favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		<header>
			<a href="../index.html" class="logo" aria-hidden="true">
				<div class="circle1"></div>
				<div class="cover1"></div>
				<div class="circle2"></div>
				<div class="cover2"></div>
				<div class="iris"></div>
			</a>
			<h1><a href="../index.html">Highly Suspect Agency</a></h1>
			<div class="spacefiller"></div>
			
			<nav><a href="../posts.html">Blog</a></nav>
		</header>
		<article>


<h1>&quot;Unable to get Windows mutable environment variable map&quot;</h1>
<div class="byline">quat, May 26, 2021<br/>
<a href="../tags/java.html">java</a> <a href="../tags/mc-modding.html">mc-modding</a> </div>

<p>I'm gonna tell a debugging story. It involves Gradle, Windows, Java 8, Java 16, and a funky package manager.</p>
<p>Okay, time to update my Gradle wrapper from an ancient Gradle 4 to the latest version as of writing this, Gradle 7.0.2.</p>
<pre><code class="language-console">$ ./gradlew wrapper --gradle-version 7.0.2

FAILURE: Build failed with an exception.

* What went wrong:
Unable to get mutable Windows environment variable map

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

* Get more help at https://help.gradle.org
</code></pre>
<p>Hm.</p>
<p>I googled for this error and, while several people have had this problem (including a few fellow Minecraft modders), nobody had posted a solution. Time to debug it myself.</p>
<p>Let's try <code>--stacktrace</code>.</p>
<pre><code class="language-console">$ ./gradlew wrapper --gradle-version 7.0.2 --stacktrace

[same error as before]

* Exception is:
net.rubygrapefruit.platform.NativeException: Unable to get mutable Windows environment variable map

		[big stacktrace]
		
Caused by: java.lang.reflect.InaccessibleObjectException: Unable to make field private static final java.util.Map java.lang.ProcessEnvironment.theCaseInsensitiveEnvironment accessible: module java.base does not &quot;opens java.lang&quot; to
unnamed module @7dc36524
        at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:357)
        at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297)
        at java.base/java.lang.reflect.Field.checkCanSetAccessible(Field.java:177)
        at java.base/java.lang.reflect.Field.setAccessible(Field.java:171)
        at net.rubygrapefruit.platform.internal.WrapperProcess.getWindowsEnv(WrapperProcess.java:124)
</code></pre>
<p>Some stuff about modules, accessibility... What version of Java is this thing running on, again?</p>
<pre><code class="language-console">$ ./gradlew --version

------------------------------------------------------------
Gradle 4.10.2
------------------------------------------------------------

Build time:   2018-09-19 18:10:15 UTC
Revision:     b4d8d5d170bb4ba516e88d7fe5647e2323d791dd

Kotlin DSL:   1.0-rc-6
Kotlin:       1.2.61
Groovy:       2.4.15
Ant:          Apache Ant(TM) version 1.9.11 compiled on March 23 2018
JVM:          16.0.1 (AdoptOpenJDK 16.0.1+9-202105072336)
OS:           Windows 10 10.0 amd64
</code></pre>
<p>Java 16 - yeah, that would do it. Frustrating. I do have both Java 8 and Java 16 installed on my computer (through <a href="https://scoop.sh/">scoop</a>, a Windows package manager), so this looks like a matter of telling Gradle which version to use.</p>
<p>Let's determine how the Gradle wrapper script, <code>gradlew</code>, discovers the Java command to use.</p>
<pre><code class="language-shell"># Determine the Java command to use to start the JVM.
if [ -n &quot;$JAVA_HOME&quot; ] ; then
    if [ -x &quot;$JAVA_HOME/jre/sh/java&quot; ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD=&quot;$JAVA_HOME/jre/sh/java&quot;
    else
        JAVACMD=&quot;$JAVA_HOME/bin/java&quot;
    fi
    if [ ! -x &quot;$JAVACMD&quot; ] ; then
        die &quot;ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation.&quot;
    fi
else
    JAVACMD=&quot;java&quot;
    which java &gt;/dev/null 2&gt;&amp;1 || die &quot;ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation.&quot;
fi
</code></pre>
<p>If the <code>JAVA_HOME</code> variable is set, it checks there first, otherwise it looks for <code>java</code> on the path.</p>
<p>Sure enough:</p>
<pre><code class="language-console">$ echo $JAVA_HOME
C:\Users\quat\scoop\apps\adopt16-hotspot-nightly\current
</code></pre>
<p>I'll change it to where my Java 8 installation is:</p>
<pre><code class="language-console">$ export JAVA_HOME=&quot;C:\Users\quat\scoop\apps\adopt8-hotspot\current&quot;

$
</code></pre>
<p>Let's try it:</p>
<pre><code class="language-console">$ ./gradlew wrapper --gradle-version 7.0.2
Starting a Gradle Daemon, 2 incompatible Daemons could not be reused, use --status for details

FAILURE: Build failed with an exception.

* Where:
Build file 'G:\Dev\fabric\carvedmelons\build.gradle' line: 2

* What went wrong:
An exception occurred applying plugin request [id: 'fabric-loom', version: '0.8-SNAPSHOT']
&gt; Failed to apply plugin [id 'fabric-loom']
   &gt; You are using an outdated version of Gradle (4.10.2). Gradle 7 or higher is required.
     You are using an outdated version of Java (8). Java 16 or higher is required.
     The JAVA_HOME environment variable is currently set to (C:\Users\quat\scoop\apps\adopt8-hotspot\current).

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.

* Get more help at https://help.gradle.org

BUILD FAILED in 5s
</code></pre>
<p>Different error, so hey, that's something!</p>
<p>Here we have a chicken-and-egg problem. I wanted to update my wrapper in the first place, because the version of the plugin I was using, <code>fabric-loom</code> version 0.8, isn't happy with Java 8 anymore.</p>
<p>But the plugin's error is preventing the wrapper-update script from running in the first place.</p>
<p>I'll resolve this by cheating, and renaming my <code>build.gradle</code> to like, <code>build.gradle.old</code> or something. Try again.</p>
<pre><code class="language-console">$ ./gradlew wrapper --gradle-version 7.0.2
&gt; Task :wrapper

BUILD SUCCESSFUL in 1s
1 actionable task: 1 executed
</code></pre>
<p>Well that took a suspiciously small amount of time, did it work?</p>
<pre><code class="language-console">$ ./gradlew --version

------------------------------------------------------------
Gradle 7.0.2
------------------------------------------------------------

Build time:   2021-05-14 12:02:31 UTC
Revision:     1ef1b260d39daacbf9357f9d8594a8a743e2152e

Kotlin:       1.4.31
Groovy:       3.0.7
Ant:          Apache Ant(TM) version 1.10.9 compiled on September 27 2020
JVM:          1.8.0_292 (AdoptOpenJDK 25.292-b10)
OS:           Windows 10 10.0 amd64
</code></pre>
<p>Looks like it did!</p>
<p>Finally I can put back my <code>build.gradle</code>, and reset my JAVA_HOME to point at Java 16. Success?</p>
<h2>Things that didn't work</h2>
<p>Initially tried to change my system PATH to put the <code>adopt8-hotspot</code> version before <code>adopt16-hotspot-nightly</code>, but that didn't work. I wasn't familiar with the <code>JAVA_HOME</code> variable and that's the one the gradle wrapper script checks first.</p>
<p>I also tried editing environment variables through the Windows &quot;edit system environment variables&quot; dialog, but I'm not sure when the &quot;git bash&quot; environment picks up on those changes...? I tried everything short of restarting my computer and changes to <code>JAVA_HOME</code> through the dialog didn't seem to be reflected. I don't know if there's another script resetting it to the adopt16 path lying around somewhere, or caching, or if I need to restart, or what.</p>
<h2>Oh</h2>
<p>A friend mentioned that you can change <code>distributionUrl</code> in <code>{project root}/.gradle/wrapper/gradle.properties</code>. That might be an easier and less error-prone way to update Gradle. Ah well.</p>
<h2>Takeaways</h2>
<p>So really, I discovered that running Gradle tasks from the terminal ran then in Java 16, but running tasks from IntelliJ ran them in Java 8.</p>
<p>The Java version used to run IDE tasks can be changed in <code>Build, Execution, Deployment &gt; Build Tools &gt; Gradle</code>. It can be set to read from <code>JAVA_HOME</code>, the <code>PATH</code>, or use a hardcoded Java path on your computer.</p>
<ul>
<li>The module system introduced in Java 9 has brought nothing but suffering into the world.</li>
<li>Pain, pain and suffering.</li>
<li>Always scan stacktraces for &quot;module&quot;-related issues, because random reflection-related crashes are almost always caused by Java 16.</li>
<li>Having both Java 8 and 16 installed on your computer is:
<ul>
<li>useful,</li>
<li><em>&quot;fun&quot;</em>,</li>
<li>probably neccesary for dealing with old Java crap - I dunno what I'd do if I didn't have a Java 8 installation lying around.</li>
<li>Maybe I should get one of those &quot;java version manager&quot; programs?</li>
</ul>
</li>
<li>Renaming build.gradle makes gradle not pick up on it. Good to keep in the back of my head.</li>
</ul>
<h1>Hey uh, wait, Loom is still crashing</h1>
<p>Now the blogpost transitions from &quot;debugging a Gradle issue&quot; to &quot;debugging Loom&quot;, because I'm updating an old Minecraft mod and it's, uh, it's still not working.</p>
<p>First two issues:</p>
<ul>
<li>Loom whined about getting ran on Java 8 again, so I checked <code>Build, Execution, Deployment &gt; Build Tools &gt; Gradle</code> in IntelliJ and set Gradle to run on Java 16 from there as well. (There's an option to make it use whatever Java's in <code>JAVA_HOME</code>.)</li>
<li>Gradle complained about insecure Maven repositories. If you cloned from <code>fabric-example-mod</code>, just open settings.gradle and change <code>'http://maven.fabricmc.net/'</code> to start with <code>https://</code>. Or wherever the repo links happen to be in your setup.</li>
</ul>
<p>Now what:</p>
<pre><code class="language-console">A problem occurred evaluating root project 'carvedmelons'.
&gt; Could not find method modCompile() for arguments [net.fabricmc:fabric-loader:0.11.0] on object of type org.gradle.api.internal.artifacts.dsl.dependencies.DefaultDependencyHandler.
</code></pre>
<p>This is because: some time between Gradle 4 and 7, they removed the &quot;compile&quot; method and renamed it to &quot;implementation&quot;. Loom folowed suit, renaming &quot;modCompile&quot; to &quot;modImplementation&quot;. Perform that rename in your buildscript.</p>
<p>Crossing my claws:</p>
<pre><code class="language-console">BUILD SUCCESSFUL in 45s
</code></pre>
<p>Cool.</p>
<h1>Wait one more thing</h1>
<p>I tried to run <code>build</code> to produce a release .jar and it said something about fabric.mod.json and &quot;duplicates&quot;. Another Gradle 4 to Gradle 7 mess.</p>
<p>In the buildscript's <code>processResources</code> block, change this:</p>
<pre><code class="language-groovy">from(sourceSets.main.resources.srcDirs) {
	include &quot;fabric.mod.json&quot;
	expand &quot;gradleversion&quot;: project.version
}
</code></pre>
<p>to this:</p>
<pre><code class="language-groovy">filesMatching(&quot;fabric.mod.json&quot;) {
	expand &quot;version&quot;: project.version
}
</code></pre>
<p>And you're golden.</p>

<hr class="cool"/>

<div style="text-align: left"><a href="fabric_datagens.html">&larr; Fabric 1.16 Datagens</a><br/>

		<div style="text-align: right; font-size:60%">Currently not powered by <a href="https://jortage.com/">Jortage</a>™</div>
		</article>
	</body>
</html>