<!DOCTYPE html>
<html>
	<head>
		<title>Highly Suspect Agency - Updating to Fabric 1.18 notes</title>
		<link rel="stylesheet" type="text/css" href="/stylin.css" />
		<link rel="stylesheet" type="text/css" href="/rotator.css" />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		<header>
			<a href="/" class="logo" aria-hidden="true">
				<div class="circle1"></div>
				<div class="cover1"></div>
				<div class="circle2"></div>
				<div class="cover2"></div>
				<div class="iris"></div>
			</a>
			<h1><a href="/">Highly Suspect Agency</a></h1>
			<div class="spacefiller"></div>
			
			<nav><a href="/posts">Blog</a></nav>
		</header>
		<article>

<h1>Updating to Fabric 1.18 notes</h1>
<div class="byline">quat, Nov 30, 2021<br/>
<a href="/tags/fabric">fabric</a> <a href="/tags/1.18">1.18</a> <a href="/tags/mc-modding">mc-modding</a> </div>

<p>I want to get off Mx. Mojang‚Äôs Wild Ride</p>
<h1>Java 17</h1>
<p>Unlike the big Java 8 to 16 jump we did last time, there are fewer weird tooling troubles with Java 17.</p>
<p>I don‚Äôt know why the process of ‚Äúgetting the most recent version of OpenJDK‚Äù seems to change every 15 minutes, but these days, go to <a href="https://adoptium.net/">Eclipse Adoptium</a> and get Temurin 17, which is relabeled OpenJDK, which is relabeled Hotspot. Why. I‚Äôm sure come the next Minecraft java version bump the process will be different again.</p>
<p>If you‚Äôre on Windows and use Scoop, <code>scoop install temurin17-jdk</code>. If you‚Äôre on Linux, I (for once) get to make fun of your package manager because it‚Äôs probably still stuck on 11. Don‚Äôt bother with Oracle‚Äôs site.</p>
<p>Couple things to check:</p>
<ul>
<li>make sure your <code>JAVA_HOME</code> is pointing at the new Java installation</li>
<li>make sure to update <code>sourceCompatibility</code>/<code>targetCompatiblity</code> in build.gradle to 17</li>
<li>make sure to update <code>compatibilityLevel</code> in your <code>mixin.json</code></li>
<li>Don‚Äôt forget to change the Java version in your continuous integration pipelines too, if you use that!</li>
</ul>
<h1>Gradle</h1>
<p>Update Gradle to 7.3. It has better support for Java 17. It sometimes works without updating the wrapper, but Github Actions in particular is <em>super</em> picky.</p>
<pre><code class="language-console">./gradlew wrapper --gradle-version 7.3

# check
./gradlew --version
</code></pre>
<h2>Troubleshooting</h2>
<p>If you‚Äôre getting crap like <code>major version 61 is newer than 60, the highest major version supported by this compiler. It is recommended that the compiler be upgraded.</code> or <code>invalid source release: 17</code>, here are some magical incantations to try:</p>
<ul>
<li>Project structure -&gt; get everything on to Java 17</li>
<li>In IntelliJ, settings -&gt; build, execution, deployment -&gt; build tools -&gt; gradle, make <em>Triple Sure</em> that the Gradle JVM is set to <code>Project SDK</code>, or is otherwise on Java 17. This is like 90% of the issues.</li>
</ul>
<p>If that didn‚Äôt work:</p>
<ul>
<li>Make sure everyone‚Äôs actually on Java 17: restart Intellij, run <code>./gradlew --stop</code> to kill the gradle daemon, etc. Double check your <code>JAVA_HOME</code></li>
<li>Delete <code>.gradle/caches/fabric-loom/1.18</code> then run any gradle task (<code>clean</code> will do) to dump any .jar files that might have been put together with an old compiler</li>
<li>If all of that doesnt work uhh idk., try lighting your computer on fire</li>
</ul>
<h3>Native libraries problem?</h3>
<p>I had some weird issue about LWJGL not being able to find native libraries, which caused the game to crash with a <code>NoClassDefFound</code> on <code>blaze3d.RenderSystem</code>. I don‚Äôt know if the following actually fixed it, but I did this and then it worked: delete the ‚ÄúMinecraft Client‚Äù and ‚ÄúMinecraft Server‚Äù run configurations, then run <code>clean</code> to have Loom re-create them.</p>
<h1>Loom</h1>
<p><a href="https://fabricmc.net/versions.html">Fabricmc versions</a> says at the bottom in bold letters, <em>The recommended loom version is 0.10-SNAPSHOT</em>, so, do that. It‚Äôs at the top of your build.gradle. It also works ok on Minecraft 1.17 so why not.</p>
<h1>Remapping</h1>
<p>If you haven‚Äôt started using official Mojang names, now is a good time to start. Yarn is atrophying a bit in the presence of Mojang‚Äôs names, since the project isn‚Äôt as needed anymore.</p>
<p>I recommend remapping to official names first, and then updating to 1.18 next. Just so you have fewer changes and less to worry about at each step.</p>
<p>To run the auto-remapper, before changing anything relating to mappings in the buildscript (so loom can figure out what mappings you‚Äôre <em>currently</em> on), run <code>gradlew migrateMappings --mappings &quot;net.minecraft:mappings:1.17.1&quot;</code>, or maybe ending in only <code>1.17</code> if your mod was written against 1.17.0. Finish up by copying <code>remappedSrc</code> over <code>src/main</code>.</p>
<p>Then, adjust your buildscript as follows. If you don‚Äôt mind not having parameter names in <code>genSources</code>, replace this:</p>
<pre><code class="language-groovy">mappings &quot;net.fabricmc:yarn:${project.yarn_mappings}:v2&quot;
</code></pre>
<p>with this:</p>
<pre><code class="language-groovy">mappings loom.officialMojangMappings() //notice the &quot;loom&quot;
</code></pre>
<p>And if you want some parameter names, the ParchmentMC project provides some. Add them to your repositories block:</p>
<pre><code class="language-groovy">repositories {
	maven {
		name = &quot;ParchmentMC&quot;
		url = &quot;https://maven.parchmentmc.net/&quot;
	}
}
</code></pre>
<p>and use this for your <code>mappings</code> instead:</p>
<pre><code class="language-groovy">mappings loom.layered() {
	officialMojangMappings() //notice no &quot;loom&quot;
	parchment(&quot;org.parchmentmc.data:parchment-1.17.1:2021.10.31@zip&quot;)
}
</code></pre>
<p>I don‚Äôt think there is a Parchment release for 1.18 yet. Parchment releases for the wrong version actually still work, though (more or less).</p>
<p>Some sharp edges with the auto remapper:</p>
<ul>
<li>If you played with Java 16 Records in your 1.17 mod, Mercury currently blows up on them. Use the intellij intention to convert them to normal classes, remap, then convert back.</li>
<li><code>@Inject</code> targets and some other Mixin string-things don‚Äôt get remapped.</li>
</ul>
<h1>Fabric API</h1>
<h2>Tool Tags</h2>
<p><code>fabric-tool-tags</code> has been deprecated. It still works, for now, but is marked <code>Deprecated(forRemoval = true)</code>. I encourage you to migrate to the vanilla <code>mineable/blah</code> block tags now, before you <em>have</em> to do it. Throw em in your datagen if you want. (fabric-api JUST landed some datagen tools, btw)</p>
<p><code>fabric-mining-level-api</code> adds additional <code>fabric:mineable/sword</code> and <code>fabric:mineable/shears</code> block tags.</p>
<h2>Block Entity Syncing</h2>
<p><code>BlockEntityClientSerializable</code> is gone ü¶Ä</p>
<p>The reason it existed in the first place was that <code>BlockEntity#getUpdatePacket</code> was not pluggable by mods, and it was hard to convince the game to actually sync your block entity data with the client. 1.18 changed <code>getUpdatePacket</code> so mods can use it, meaning a workaround is no longer needed.</p>
<p>There is a general-purpose block entity syncing vanilla packet, mojang name <code>ClientboundBlockEntityDataPacket</code>. It calls <code>BlockEntity#getUpdateTag</code> on the server and sends the resulting compound tag to the client, which proceeds to call the normal <code>BlockEntity#load</code> method on the client world with it.</p>
<p>Many vanilla <code>BlockEntity</code>s have this boilerplate:</p>
<pre><code class="language-java">@Override
public Packet&lt;ClientGamePacketListener&gt; getUpdatePacket() {
	return ClientboundBlockEntityDataPacket.create(this);
}

@Override
public CompoundTag getUpdateTag() {
	//calls into &quot;saveAdditional&quot;, which is the mojang name for
	//the general-purpose &quot;write my data to NBT&quot; method on BlockEntities
	//that you are familiar with
	return saveWithoutMetadata();
}
</code></pre>
<p>This setup will sync the entirety of the server‚Äôs NBT tag (save the redundant <code>id</code> and <code>x</code>/<code>y</code>/<code>z</code> fields, which aren‚Äôt written when using <code>saveWithoutMetadata</code>) to the client. If you don‚Äôt want to send the <em>entire</em> tag, return something different in <code>getUpdateTag</code> (see: the campfire).</p>
<p>Calling <code>level.sendBlockUpdated(getBlockPos(), getBlockState(), getBlockState(), 3);</code> will fire the server-to-client sync packet, just like what <code>BlockEntityClientSerializable#sync</code> did. That‚Äôs kind of a mouthful of a method name, and you typically want to call it in the same contexts you‚Äôd mark the chunk dirty in, so many vanilla <code>BlockEntity</code>s have this helper method defined as well:</p>
<pre><code class="language-java">//(not an @Override!)
private void markUpdated() {
	//you may know this one as &quot;markDirty&quot;:
	setChanged();
	//causes the update packet to be sent:
	level.sendBlockUpdated(getBlockPos(), getBlockState(), getBlockState(), 3);
}
</code></pre>
<p>Know that the vanilla <code>ClientboundBlockEntityDataPacket</code> calls the same <code>load</code> method that loading a <code>BlockEntity</code> on the server calls. (You are free to make your own <code>Packet&lt;?&gt;</code> and return it in <code>getUpdatePacket</code>, although it‚Äôs a bit awkward because I don‚Äôt know if you can use the fabric-api convention of custom payload packets here.)</p>
<h1>Of interest to codecbrained dorks:</h1>
<p><code>Registry&lt;T&gt;</code> no longer directly implements <code>Codec&lt;T&gt;</code>, but it does offer a <code>byNameCodec()</code> method. The returned codec works the same as it used to; i.e. it saves and loads the registry entry to its <code>ResourceLocation</code>.</p>

<hr class="cool"/>

<div style="text-align: left"><a href="/posts/what_the_hell_is_a_build_system">&larr; What the hell is a good build system</a><br/>
<div style="text-align: right"><a href="/posts/where_has_all_the_memory_gone">Where has all the memory gone? &rarr;</a>
		<div style="text-align: right; font-size:60%">Powered by <a href="https://github.com/quat1024/quatweb-static">Rust</a>‚Ñ¢</div>
		</article>
	</body>
</html>