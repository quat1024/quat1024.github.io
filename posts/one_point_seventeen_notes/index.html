<!DOCTYPE html>
<html lang="en">
<head>
<title>Updating to Fabric 1.17 notes - Highly Suspect Agency</title>
<meta property="og:title" content="Updating to Fabric 1.17 notes">
<meta property="og:description" content="Aggregated notes on updating mods to Fabric 1.17">
<meta property="og:type" content="website">
<meta property="og:url" content="https://highlysuspect.agency">
<meta property="og:image" content="https://highlysuspect.agency/favicon128.png">
<meta property="theme-color" content="#950000">
<link rel="stylesheet" type="text/css" href="/stylin.css">
<link rel="stylesheet" type="text/css" href="/rotator.css">
<link rel="alternate" type="application/rss+xml" href="/feed.xml">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<header>
<a href="/" class="sign" aria-hidden="true">
<div class="circle s1"></div><div class="cover s2"></div><div class="circle s3"></div><div class="cover s4"></div><div class="iris"></div>
</a>
<h1><a href="/">Highly Suspect Agency</a></h1>
<div style="flex-grow: 1"></div>
<nav><a href="/feed.xml">RSS</a> <a href="/posts">Blog</a></nav>
</header>
<div class="bigheader">
<h1>Updating to Fabric 1.17 notes</h1>
<div class="byline">quat, Jun 08, 2021 &mdash; <a href="/tags/mc-modding">mc-modding</a> <a href="/tags/fabric">fabric</a> <a href="/tags/1.17">1.17</a> </div>
</div>
<article>
<p>Let's get right into it:</p>
<h1>part 1: Updating to Java 16</h1>
<p>Minecraft 1.17 runs on Java 16, and it's in your best interest to get everything on the Java 16 boat as soon as you can.</p>
<p>Quick checklist for IDEA users:</p>
<ul>
<li>Ensure the <code>JAVA_HOME</code> environment variable points to a valid Java 16 installation.</li>
<li>Use at least Gradle version 7.0.2. You can see my previous blogpost for instructions on how to update the hard way, or update the easy way by changing the number in <code>distributionUrl</code> of <code>gradle/wrapper/gradle-wrapper.properties</code> to <code>7.0.2</code>.</li>
<li>File -&gt; Project Structure -&gt; Project: set <code>Project SDK</code> to 16, and <code>Language Level</code> to &quot;SDK default&quot; (top of the list).</li>
<li>File -&gt; Settings -&gt; Build, Execution Deployment -&gt; Build Tools -&gt; Gradle: ensure <code>Gradle JVM</code> is &quot;SDK default&quot;.</li>
<li>In your run configurations, ensure that you're gonna run the game with Java 16.</li>
</ul>
<h2>Buildscript</h2>
<p>I'm going to assume your buildscript is shaped after the one in fabric-example-mod, and that you didn't tweak it toooooo too much.</p>
<h3>Preparing for Java 16</h3>
<p>If you have a <code>sourceCompatibility</code> and <code>targetCompatibilty</code> setting at the top, change them to <code>16</code> or <code>JavaVersion.VERSION_16</code>.</p>
<p>The <code>tasks.withType(JavaCompile).configureEach</code> block, present in somewhat recently-cloned <code>fabric-example-mod</code>s has this block:</p>
<pre><code class="language-groovy">// The Minecraft launcher currently installs Java 8 for users, so your mod probably wants to target Java 8 too
// JDK 9 introduced a new way of specifying this that will make sure no newer classes or methods are used.
// We'll use that if it's available, but otherwise we'll use the older option.
def targetVersion = 8
if (JavaVersion.current().isJava9Compatible()) {
	 it.options.release = targetVersion
}
</code></pre>
<p>This is obviously not relevant anymore, and can be erased.</p>
<h3>Making things work on Gradle 7</h3>
<ul>
<li>
<p>Open <code>settings.gradle</code> and make sure things are using <code>https</code>.</p>
</li>
<li>
<p>Find-replace <code>modCompile</code> with <code>modImplementation</code>.</p>
</li>
</ul>
<p>Finally, to fix the <code>build</code> task, change this:</p>
<pre><code class="language-groovy">from(sourceSets.main.resources.srcDirs) {
	include &quot;fabric.mod.json&quot;
	expand &quot;version&quot;: project.version
}
</code></pre>
<p>to this:</p>
<pre><code class="language-groovy">filesMatching(&quot;fabric.mod.json&quot;) {
	expand &quot;version&quot;: project.version
}
</code></pre>
<h2>Optional: loom 0.8</h2>
<p>Strictly speaking it's optional but I do recommend doing this.</p>
<p><em>After</em> getting everything prepared for Gradle 7 and Java 16, change the Loom version at the top to <code>0.8-SNAPSHOT</code>.</p>
<h3>Github CI</h3>
<p>Since Loom 0.8 only runs on Java 16, you will need to update your CI file to use Java 16. Here, go <a href="https://github.com/quat1024/AutoThirdPerson/blob/bb387e048a1463cb0c0f58112a360048ed1dd204/.github/workflows/build.yml">copy-paste mine</a>.</p>
<h1>part 2: running migrateMappings</h1>
<p>See <a href="https://fabricmc.net/versions.html">the Fabric versions page</a>. The provided gradle incantation will remap the sources in <code>/src/main/java</code> and put them in <code>/remappedSrc</code>. It's not done in-place, but since you <em>are</em> using version control (right ðŸ‘€) it's okay to overwrite your old sources.</p>
<p>You can skip this if your mod is really small; a couple missing mappings here-and-there aren't hard to manually fix. They don't crop up very often.</p>
<h2>Getting acquainted with the new mappings</h2>
<p>Late in the 1.17 cycle, Mojang stopped instructing ProGuard to strip unused fields and methods. Many of these are as-of-now unmapped, and Fabric's tooling (controversially?) does not use the official Mojang names.</p>
<p>You are going to see a lot of unmapped <code>static final int</code> fields lying around, that's just the way things are right now.</p>
<h1>part 3: starting the engine</h1>
<p>Also on <a href="https://fabricmc.net/versions.html">versions.html</a> is a block you can paste into your <code>gradle.properties</code> to check out the latest versions of Minecraft, Yarn mappings, Fabric Loader, and fabric-api. Do that, refresh, maybe run <code>genSources</code> as well, and</p>
<p>Oh no</p>
<p>Oh there's a lot of compile errors aren't there</p>
<h1>part 4: The fun part</h1>
<p>Here's the part where I dump all the &quot;stuff that I noticed was broken in my mods&quot; on you. This is not an exhaustive list, and only mentions the things that my own mods happen to use.</p>
<h2>Block entities</h2>
<p>The constructor that you must call when you extend <code>BlockEntity</code> now takes a <code>BlockPos</code> and <code>BlockState</code>, as well as a <code>BlockEntityType</code>. Side-effects of this change:</p>
<ul>
<li><code>createBlockEntity</code> in <code>BlockEntityProvider</code>, the thing you extend to make your block have a BE, also takes a <code>BlockPos</code> and <code>BlockState</code> argument instead of a <code>BlockView</code> (world) argument.</li>
<li>If you instantiated your BEs through <code>BlockEntityType</code>s, the <code>instantiate</code> method on them has changed accordingly.</li>
<li><code>readNbt</code> no longer takes a <code>BlockState</code>, since you already have it from the contructor.</li>
</ul>
<h3>Goddammit mojang</h3>
<p><code>BlockEntityType#BlockEntityFactory</code> is now private for no reason at all, so you can't actually register any block entity types. Find-replace <code>BlockEntityType.Builder</code> with <code>FabricBlockEntityTypeBuilder</code>.</p>
<h3><code>Tickable</code></h3>
<p><code>Tickable</code> is <em>completely</em> gone. (Shock, horror.)</p>
<p>The <code>BlockEntityProvider</code> interface now includes a <code>getTicker</code> method. Given a world, state, and block-entity type, you may return <code>null</code> if you don't tick, or a <code>(World, BlockPos, BlockState, BlockEntity) -&gt; void</code> function if you do, and it'll get added to a list of tickers.</p>
<p>Importantly, you may return different tickers depending on the <code>isClient</code>-ness of the provided <code>World</code>, or even return <code>null</code> on one side and a ticker on the other.</p>
<p>Irritatingly, <code>BlockEntity</code> is the <em>last</em> parameter in the list, so you need to make a static method somewhere.</p>
<p>You'll want a method like this:</p>
<pre><code class="language-java">@Nullable
public static &lt;A extends BlockEntity, B extends BlockEntity&gt; BlockEntityTicker&lt;B&gt; castTicker(BlockEntityType&lt;B&gt; givenType, BlockEntityType&lt;A&gt; expectedType, BlockEntityTicker&lt;? super A&gt; ticker) {
	//noinspection unchecked
	return expectedType == givenType ? (BlockEntityTicker&lt;B&gt;) ticker : null;
}
</code></pre>
<p>(<code>BlockEntityProvider</code> also has a <code>getGameEventListener</code> method, btw, if you want to create something like the skulk sensor.)</p>
<h2>Tags</h2>
<p>If you were using <code>Item#isIn</code>, it's not public anymore. Use <code>Tag#contains</code>.</p>
<h2>Uhh</h2>
<p>Probably most relevant to the datagen crew: <code>ItemPredicate</code> takes <code>items</code> instead of a single <code>item</code> now.</p>
<hr class="cool">
<div style="text-align: left"><a href="/posts/unable_to_get_windows_mutable_environment_variable_map">&larr; "Unable to get Windows mutable environment variable map"</a></div>
<div style="text-align: right"><a href="/posts/what_the_hell_is_a_build_system">What the hell is a good build system &rarr;</a></div>
<div style="text-align: right; font-size:60%">Powered by <a href="https://github.com/quat1024/quatweb-static">Rust</a>â„¢</div>
</article>
</body>
</html>
